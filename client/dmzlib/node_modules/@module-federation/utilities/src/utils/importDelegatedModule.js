"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.importDelegatedModule = void 0;
const pure_1 = require("./pure");
const importDelegatedModule = (keyOrRuntimeRemoteItem) => __awaiter(void 0, void 0, void 0, function* () {
    // @ts-ignore
    return (0, pure_1.loadScript)(keyOrRuntimeRemoteItem)
        .then((asyncContainer) => {
        return asyncContainer;
    })
        .then((asyncContainer) => {
        // most of this is only needed because of legacy promise based implementation
        // can remove proxies once we remove promise based implementations
        if (typeof window === 'undefined') {
            if (!Object.hasOwnProperty.call(keyOrRuntimeRemoteItem, 'globalThis')) {
                return asyncContainer;
            }
            // return asyncContainer;
            //TODO: need to solve chunk flushing with delegated modules
            return {
                get: function (arg) {
                    //@ts-ignore
                    return asyncContainer.get(arg).then((f) => {
                        const m = f();
                        const result = {
                            __esModule: m.__esModule,
                        };
                        for (const prop in m) {
                            if (typeof m[prop] === 'function') {
                                Object.defineProperty(result, prop, {
                                    get: function () {
                                        return function () {
                                            //@ts-ignore
                                            if (globalThis.usedChunks)
                                                //@ts-ignore
                                                globalThis.usedChunks.add(
                                                //@ts-ignore
                                                `${keyOrRuntimeRemoteItem.global}->${arg}`);
                                            //eslint-disable-next-line prefer-rest-params
                                            return m[prop](...arguments);
                                        };
                                    },
                                    enumerable: true,
                                });
                            }
                            else {
                                Object.defineProperty(result, prop, {
                                    get: () => {
                                        //@ts-ignore
                                        if (globalThis.usedChunks)
                                            //@ts-ignore
                                            globalThis.usedChunks.add(
                                            //@ts-ignore
                                            `${keyOrRuntimeRemoteItem.global}->${arg}`);
                                        return m[prop];
                                    },
                                    enumerable: true,
                                });
                            }
                        }
                        if (m.then) {
                            return Promise.resolve(() => result);
                        }
                        return () => result;
                    });
                },
                init: asyncContainer.init,
            };
        }
        else {
            return asyncContainer;
        }
    });
});
exports.importDelegatedModule = importDelegatedModule;
//# sourceMappingURL=importDelegatedModule.js.map